AWSTemplateFormatVersion: "2010-09-09"
Description: ""
Parameters:
  CodeBuildProjectName:
    Description: Name of the code build project
    Type: String
    
Resources:

    IAMManagedPolicy:
        Type: "AWS::IAM::ManagedPolicy"
        Properties:
            ManagedPolicyName: !Sub "CodeBuildBasePolicy-${CodeBuildProjectName}-${AWS::Region}"
            Path: "/"
            PolicyDocument: !Sub |
                {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Resource": [
                                "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${CodeBuildProjectName}",
                                "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${CodeBuildProjectName}:*"
                            ],
                            "Action": [
                                "logs:CreateLogGroup",
                                "logs:CreateLogStream",
                                "logs:PutLogEvents"
                            ]
                        },
                        {
                            "Effect": "Allow",
                            "Resource": [
                                "arn:aws:s3:::codepipeline-${AWS::Region}-*"
                            ],
                            "Action": [
                                "s3:PutObject",
                                "s3:GetObject",
                                "s3:GetObjectVersion",
                                "s3:GetBucketAcl",
                                "s3:GetBucketLocation"
                            ]
                        },
                        {
                            "Effect": "Allow",
                            "Action": [
                                "codebuild:CreateReportGroup",
                                "codebuild:CreateReport",
                                "codebuild:UpdateReport",
                                "codebuild:BatchPutTestCases",
                                "codebuild:BatchPutCodeCoverages"
                            ],
                            "Resource": [
                                "arn:aws:codebuild:${AWS::Region}:${AWS::AccountId}:report-group/${CodeBuildProjectName}-*"
                            ]
                        },
                        {
                          "Effect": "Allow",
                          "Action": [ "codeartifact:GetAuthorizationToken",
                                      "codeartifact:GetRepositoryEndpoint",
                                      "codeartifact:ReadFromRepository"
                                      ],
                          "Resource": "*"
                        },
                        {       
                          "Effect": "Allow",
                          "Action": "sts:GetServiceBearerToken",
                          "Resource": "*",
                          "Condition": {
                              "StringEquals": {
                                  "sts:AWSServiceName": "codeartifact.amazonaws.com"
                              }
                          }
                        }
                    ]
                }
                
    IAMRole:
        Type: "AWS::IAM::Role"
        Properties:
            Path: "/"
            RoleName: !Sub "codebuild-${CodeBuildProjectName}-service-role"
            AssumeRolePolicyDocument:
                Statement:
                - Effect: Allow
                  Principal:
                    Service:
                    - codebuild.amazonaws.com
                  Action:
                  - sts:AssumeRole
            ManagedPolicyArns: 
              - !Ref IAMManagedPolicy
              - "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryFullAccess"
              - "arn:aws:iam::aws:policy/AWSCodeArtifactAdminAccess"